<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hypersmart.usercenter.mapper.GridBasicInfoMapper">
    <resultMap id="DtoResultMap" type="com.hypersmart.usercenter.dto.GridBasicInfoDTO">
        <id column="id" jdbcType="VARCHAR" property="id" />
        <result column="grid_code" jdbcType="VARCHAR" property="gridCode" />
        <result column="grid_name" jdbcType="VARCHAR" property="gridName" />
        <result column="grid_type" jdbcType="VARCHAR" property="gridType" />
        <result column="grid_range" jdbcType="VARCHAR" property="gridRange" />
        <result column="grid_remark" jdbcType="VARCHAR" property="gridRemark" />
        <result column="area_id" jdbcType="VARCHAR" property="areaId" />
        <result column="city_id" jdbcType="VARCHAR" property="cityId" />
        <result column="project_id" jdbcType="VARCHAR" property="projectId" />
        <result column="massif_id" jdbcType="VARCHAR" property="massifId" />
        <result column="staging_id" jdbcType="VARCHAR" property="stagingId" />
        <result column="housekeeper_id" jdbcType="VARCHAR" property="housekeeperId" />
        <result column="update_times" jdbcType="VARCHAR" property="updateTimes" />
        <result column="format_attribute" jdbcType="VARCHAR" property="formatAttribute" />
        <result column="creation_date" jdbcType="TIMESTAMP" property="creationDate" />
        <result column="created_by" jdbcType="VARCHAR" property="createdBy" />
        <result column="enabled_flag" jdbcType="TINYINT" property="enabledFlag" />
    </resultMap>

    <resultMap id="SimpleDTOMap" type="com.hypersmart.usercenter.dto.GridBasicInfoSimpleDTO">
        <id column="id" jdbcType="VARCHAR" property="id" />
        <result column="grid_name" jdbcType="VARCHAR" property="gridName" />
        <result column="staging_id" jdbcType="VARCHAR" property="stagingId" />
        <result column="housekeeper_id" jdbcType="VARCHAR" property="housekeeperId" />
    </resultMap>
    <sql id="BaseTable">
    grid_basic_info
    </sql>

    <select id="getGridBasicInfoByHouseKeeperIds" resultMap="SimpleDTOMap" >
        SELECT
        a.id,
        a.grid_name,
        a.staging_id,
        a.housekeeper_id
        FROM
        grid_basic_info a
        where
        a.is_deleted = 0
        and a.enabled_flag = 1
        and
        <foreach collection="houseKeeperBO" index="index" item="houseKeeper" open="(" separator="or" close=")">
            (a.housekeeper_id =#{houseKeeper.houseKeeperId} and a.staging_id = #{houseKeeper.divideId})
        </foreach>
        order by a.creation_date desc
    </select>

    <select id="quertList" parameterType="java.util.Map" resultType="java.util.Map">
        select t.*, r.procInstId, r.approvalStatus from (
            select g.id as id,
            g.grid_range as gridRange,
            g.grid_name as gridName,
            g.grid_type as gridType,
            g.grid_code as gridCode,
            g.grid_remark as gridRemark,
            g.area_id as areaId,
            g.project_id as projectId,
            g.city_id as cityId,
            g.staging_id as stagingId,
            g.staging_id as divideId,
            g.housekeeper_id as housekeeperId,
            g.format_attribute as formatAttribute,
            g.second_format_attribute as secondFormatAttribute,
            g.third_format_attribute as thirdFormatAttribute,
            concat('',g.enabled_flag,'') as enabledFlag,
            g.is_deleted as isDeleted,
            g.creation_date as creationDate,
            (select org.NAME_ from uc_org org where ID_ = g.area_id) as areaName,
            (select org.NAME_ from uc_org org where ID_ = g.project_id) as projectName,
            (select org.NAME_ from uc_org org where ID_ = g.city_id) as cityName,
            (select org.NAME_ from uc_org org where ID_ = g.staging_id) as stagingName,
            k.fullName as housekeeperName
            from grid_basic_info g LEFT JOIN (
            SELECT
                u.ID_ AS houseKeeperId,
                uou.ID_ AS id,
                u.FULLNAME_ AS fullName,
                u.MOBILE_ AS mobile,
                u.ACCOUNT_ AS account,
                post.ID_ AS `postId`,
                post.POS_NAME_ AS posName,
                org.NAME_ AS divideName,
                org.ID_ AS divideId
                FROM
                uc_user u
                JOIN uc_org_user uou ON u.ID_ = uou.USER_ID_
                JOIN uc_org org ON uou.ORG_ID_ = org.ID_
                JOIN uc_org_post post ON uou.POS_ID_ = post.ID_
                JOIN uc_org_job uoj ON post.JOB_ID_ = uoj.ID_
                JOIN uc_demension dem ON org.DEM_ID_ = dem.ID_
                WHERE
                uoj.CODE_ = 'guanjia'
                AND dem.CODE_ = 'smsf'
                AND org.GRADE_ = 'ORG_DiKuai'
                and u.IS_DELE_ = 0 and uou.IS_DELE_ = 0 and org.IS_DELE_ = 0 and post.IS_DELE_ = 0 and uoj.IS_DELE_ = 0 and dem.IS_DELE_ = 0
            ) as k on g.staging_id = k.divideId and g.housekeeper_id = k.houseKeeperId where g.staging_id = #{massifId} and g.is_deleted = 0
        ) as t
        LEFT JOIN (
            SELECT
            gr.grid_id,
            gr.approval_status AS approvalStatus,
            gr.proc_inst_Id AS procInstId
            FROM
            grid_approval_record gr
            WHERE
            gr.create_date = ( SELECT max( create_date ) FROM grid_approval_record WHERE grid_id = gr.grid_id )
        ) r ON r.grid_id = t.id
        <where>
            <if test="whereSql!=null">
                ${whereSql}
            </if>
        </where>
        <if test="orderBySql!=null">
            ORDER BY ${orderBySql}
        </if>
    </select>

    <select id="queryAssociateList" parameterType="java.util.Map" resultType="java.util.Map">
        select t.*, r.procInstId, r.approvalStatus from (
        select g.id as id,
        g.grid_range as gridRange,
        g.grid_name as gridName,
        g.grid_type as gridType,
        g.grid_code as gridCode,
        g.grid_remark as gridRemark,
        g.area_id as areaId,
        g.project_id as projectId,
        g.city_id as cityId,
        g.staging_id as stagingId,
        g.staging_id as divideId,
        g.housekeeper_id as housekeeperId,
        g.format_attribute as formatAttribute,
        g.second_format_attribute as secondFormatAttribute,
        g.third_format_attribute as thirdFormatAttribute,
        concat('',g.enabled_flag,'') as enabledFlag,
        g.is_deleted as isDeleted,
        g.creation_date as creationDate,
        (select org.NAME_ from uc_org org where ID_ = g.area_id) as areaName,
        (select org.NAME_ from uc_org org where ID_ = g.project_id) as projectName,
        (select org.NAME_ from uc_org org where ID_ = g.city_id) as cityName,
        (select org.NAME_ from uc_org org where ID_ = g.staging_id) as stagingName,
        k.fullName as housekeeperName
        from grid_basic_info g LEFT JOIN (
        SELECT
        u.ID_ AS houseKeeperId,
        uou.ID_ AS id,
        u.FULLNAME_ AS fullName,
        u.MOBILE_ AS mobile,
        u.ACCOUNT_ AS account,
        post.ID_ AS `postId`,
        post.POS_NAME_ AS posName,
        org.NAME_ AS divideName,
        org.ID_ AS divideId
        FROM
        uc_user u
        JOIN uc_org_user uou ON u.ID_ = uou.USER_ID_
        JOIN uc_org org ON uou.ORG_ID_ = org.ID_
        JOIN uc_org_post post ON uou.POS_ID_ = post.ID_
        JOIN uc_org_job uoj ON post.JOB_ID_ = uoj.ID_
        JOIN uc_demension dem ON org.DEM_ID_ = dem.ID_
        WHERE
        uoj.CODE_ = 'guanjia'
        AND dem.CODE_ = 'smsf'
        AND org.GRADE_ = 'ORG_DiKuai'
        and u.IS_DELE_ = 0 and uou.IS_DELE_ = 0 and org.IS_DELE_ = 0 and post.IS_DELE_ = 0 and uoj.IS_DELE_ = 0 and dem.IS_DELE_ = 0
        ) as k on g.staging_id = k.divideId and g.housekeeper_id = k.houseKeeperId where g.staging_id = #{massifId} and g.is_deleted = 0
        ) as t
        LEFT JOIN (
        SELECT
        gr.grid_id,
        gr.approval_status AS approvalStatus,
        gr.proc_inst_Id AS procInstId
        FROM
        grid_approval_record gr
        WHERE
        gr.create_date = ( SELECT max( create_date ) FROM grid_approval_record WHERE grid_id = gr.grid_id )
        ) r ON r.grid_id = t.id
        <where>
            <if test="whereSql!=null">
                ${whereSql}
            </if>
            and (approvalStatus is null or approvalStatus !=1)
        </where>
        <if test="orderBySql!=null">
            ORDER BY ${orderBySql}
        </if>
    </select>

    <select id="getGridById" parameterType="java.lang.String" resultType="java.util.Map">
        select g.id as id,
        g.grid_range as gridRange,
        g.grid_name as gridName,
        g.grid_type as gridType,
        g.grid_code as gridCode,
        g.grid_remark as gridRemark,
        g.area_id as areaId,
        g.project_id as projectId,
        g.city_id as cityId,
        g.staging_id as stagingId,
        g.staging_id as divideId,
        g.housekeeper_id as housekeeperId,
        g.format_attribute as formatAttribute,
        g.second_format_attribute as secondFormatAttribute,
        g.third_format_attribute as thirdFormatAttribute,
        concat('',g.enabled_flag,'') as enabledFlag,
        (select org.NAME_ from uc_org org where ID_ = g.area_id) as areaName,
        (select org.NAME_ from uc_org org where ID_ = g.project_id) as projectName,
        (select org.NAME_ from uc_org org where ID_ = g.city_id) as cityName,
        (select org.NAME_ from uc_org org where ID_ = g.staging_id) as stagingName,
        k.fullName as housekeeperName
        from grid_basic_info g LEFT JOIN (SELECT
        u.ID_ AS houseKeeperId,
        uou.ID_ AS id,
        u.FULLNAME_ AS fullName,
        u.MOBILE_ AS mobile,
        u.ACCOUNT_ AS account,
        post.ID_ AS `postId`,
        post.POS_NAME_ AS posName,
        org.NAME_ AS divideName,
        org.ID_ AS divideId
        FROM
        uc_user u
        JOIN uc_org_user uou ON u.ID_ = uou.USER_ID_
        JOIN uc_org org ON uou.ORG_ID_ = org.ID_
        JOIN uc_org_post post ON uou.POS_ID_ = post.ID_
        JOIN uc_org_job uoj ON post.JOB_ID_ = uoj.ID_
        JOIN uc_demension dem ON org.DEM_ID_ = dem.ID_
        WHERE
        uoj.CODE_ = 'guanjia'
        AND dem.CODE_ = 'smsf'
        AND org.GRADE_ = 'ORG_DiKuai'
        and u.IS_DELE_ = 0 and uou.IS_DELE_ = 0 and org.IS_DELE_ = 0 and post.IS_DELE_ = 0 and uoj.IS_DELE_ = 0 and dem.IS_DELE_ = 0
        ) as k on g.staging_id = k.divideId and g.housekeeper_id = k.houseKeeperId
        where g.id = #{id}
    </select>

    <update id="disableGridInfo" parameterType="com.hypersmart.usercenter.bo.GridBasicInfoBO">
        update grid_basic_info
        set enabled_flag = 0, grid_range = null, update_times = update_times + 1, updated_by = #{updatedBy}, updation_date = now()
        where id in
        <foreach collection="ids" index="index" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </update>

    <update id="deleteGridInfo" parameterType="com.hypersmart.usercenter.bo.GridBasicInfoBO">
        update grid_basic_info
        set is_deleted = 1, grid_range = null, update_times = update_times + 1, updated_by = #{updatedBy}
        where id in
        <foreach collection="ids" index="index" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </update>

    <select id="getByGridRange" parameterType="java.lang.String" resultType="com.hypersmart.usercenter.model.GridBasicInfo">
        select 	id,
        grid_code as gridCode,
        grid_name AS gridName,
        grid_type as gridType,
        grid_range as gridRange,
        grid_remark as gridRemark,
        area_id as areaId,
        project_id as projectId,
        massif_id as massifId,
        staging_id as stagingId,
        city_id as cityId,
        housekeeper_id as housekeeperId,
        update_times as updateTimes,
        format_attribute as formatAttribute,
        second_format_attribute as secondFormatAttribute,
        third_format_attribute as thirdFormatAttribute,
        creation_date as creationDate,
        created_by as createdBy,
        updation_date as updationDate,
        updated_by as updatedBy,
        row_time as rowTime,
        row_version as rowVersion,
        tenant_id as tenantId,
        enabled_flag as enabledFlag,
        is_deleted as isDeleted
        from
        grid_basic_info
        <where>
            is_deleted = '0'
            <if test="gridRange!=null and gridRange!=''">
                AND grid_range LIKE CONCAT('%',#{gridRange},'%')
            </if>
        </where>
    </select>

</mapper>